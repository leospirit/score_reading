<!DOCTYPE html>
<html lang="zh-CN">
{% macro get_level(score) -%}
    {% if score >= 90 %}Advanced{% elif score >= 80 %}High-Intermediate{% elif score >= 70 %}Intermediate{% elif score >= 60 %}Basic{% else %}Beginner{% endif %}
{%- endmacro %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£è¯­è¯„åˆ†æŠ¥å‘Š - {{ meta.student_name or meta.student_id }}</title>
    <!-- å¼•å…¥ WaveSurfer.js å’Œ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Google Fonts (Skill æ¨è: Outfit + Work Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Work+Sans:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-ok: #00C853;     /* Green */
            --color-weak: #FF9100;   /* Orange */
            --color-missing: #FF1744; /* Red */
            --color-poor: #AA00FF;    /* Purple */
            
            /* Light Theme */
            --bg-page: #F8FAFC;      /* Skill å»ºè®®: Slate-50 å†·è‰²è°ƒæµ…ç° */
            --bg-card: #ffffff;
            --text-primary: #1E293B; /* Slate-800 */
            --text-secondary: #64748B; /* Slate-500 */
            --accent: #2979FF;       /* Blue */
            
            /* Gradients */
            --grad-overall: linear-gradient(135deg, #00E5FF 0%, #2979FF 100%);
            --grad-pronunciation: linear-gradient(to right, #2979FF, #448AFF);
            --grad-fluency: linear-gradient(to right, #FF9100, #FFB74D);
            --grad-intonation: linear-gradient(to right, #00C853, #69F0AE);
            --grad-completeness: linear-gradient(to right, #AA00FF, #EA80FC);
            
            /* Shadows (Soft UI) */
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --font-heading: 'Outfit', sans-serif;
            --font-body: 'Work Sans', sans-serif;
            --font-text: 'Inter', sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        h1, h2, h3, .number, .value, .skill-score {
            font-family: var(--font-heading);
        }
        
        .container {
            max-width: 800px; /* ç´§å‡‘å®½åº¦ */
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨ä¿¡æ¯ - æç®€ */
        .header {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(0,0,0,0.02);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.2rem; /* å‡å°æ ‡é¢˜ */
            margin-bottom: 0;
            color: var(--accent);
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-item .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.7;
        }
        
        .meta-item .value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* åˆ†æ•°åŒºåŸŸ - å·¦å³å¸ƒå±€ */
        .scores-section {
            display: grid;
            grid-template-columns: 200px 1fr; /* å·¦ä¾§åœ†ç¯ï¼Œå³ä¾§åˆ†é¡¹ */
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* ç»¼åˆè¯„åˆ†å¡ç‰‡ */
        .overall-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.02);
            height: 100%;
        }
        
        .ring-container {
            width: 140px; /* ç¼©å°åœ†ç¯ */
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .ring-center .value {
            font-size: 2rem;
            margin-bottom: 2px;
        }

        .overall-feedback {
            text-align: center;
        }
        
        .overall-feedback h2 {
            display: none; /* éšè—æ ‡é¢˜ä»¥èŠ‚çœç©ºé—´ */
        }
        
        .overall-feedback .level-badge {
            margin-bottom: 0;
            padding: 4px 10px;
            font-size: 0.8rem;
        }
        
        .overall-feedback p {
            display: none; /* éšè—é•¿æ–‡æœ¬å»ºè®®ï¼Œå•é¡µæ”¾ä¸ä¸‹ */
        }

        /* åˆ†é¡¹è¯„åˆ† - ç´§å‡‘ç½‘æ ¼ */
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
        }
        
        .skill-card {
            padding: 16px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .skill-score {
            font-size: 1.8rem; /* å‡å°åˆ†é¡¹åˆ†æ•°å­—å· */
            margin: 4px 0;
        }
        
        .skill-label {
            font-size: 0.9rem;
        }
        
        .skill-level {
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .overall-card {
                flex-direction: column;
                text-align: center;
                padding: 24px;
            }
        }
        
        .ring-container {
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }
        
        .ring-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .ring-center .value {
            font-size: 2.6rem; /* å¢å¤§æ•°å­— */
            font-weight: 800;
            background: var(--grad-overall);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
            margin-bottom: 4px;
            letter-spacing: -1px; /* ç´§å‡‘ä¸€ç‚¹ */
        }
        
        .ring-center .unit {
            font-size: 0.65rem; /* ç¼©å°ç­‰çº§æ–‡å­— */
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px; /* å¢åŠ é—´è· */
            opacity: 0.8;
            line-height: 1.2;
            max-width: 120px; /* é˜²æ­¢æ–‡å­—è¿‡é•¿æ¢è¡Œéš¾çœ‹ */
            margin: 0 auto;
        }
        
        .overall-feedback {
            flex: 1;
        }
        
        .overall-feedback h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .overall-feedback .level-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(41, 121, 255, 0.1);
            color: var(--accent);
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        
        .overall-feedback p {
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 600px;
        }
        
        /* åˆ†é¡¹è¯„åˆ†å¡ç‰‡ç½‘æ ¼ */
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .skill-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-card);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            border-top: 4px solid transparent;
            border-bottom: 1px solid rgba(0,0,0,0.02);
            border-left: 1px solid rgba(0,0,0,0.02);
            border-right: 1px solid rgba(0,0,0,0.02);
        }
        
        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .skill-card.pronunciation { border-top-color: #2979FF; }
        .skill-card.intonation { border-top-color: #00C853; }
        .skill-card.fluency { border-top-color: #FF9100; }
        .skill-card.completeness { border-top-color: #AA00FF; }
        
        .skill-score {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
            line-height: 1;
        }
        
        .skill-card.pronunciation .skill-score { color: #2979FF; }
        .skill-card.intonation .skill-score { color: #00C853; }
        .skill-card.fluency .skill-score { color: #FF9100; }
        .skill-card.completeness .skill-score { color: #AA00FF; }
        
        .skill-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .skill-level {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        

        
        /* æ–‡æœ¬é«˜äº®åŒºåŸŸ */
        .text-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .text-section h2 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        .highlighted-text {
            font-family: var(--font-text);
            font-size: 1.05rem; /* å‡å°å­—å· */
            line-height: 1.8;   /* å‡å°è¡Œé«˜ */
            padding: 20px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 12px;
            text-align: justify;
        }
        
        .highlighted-text .word {
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .highlighted-text .word:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .highlighted-text .word.playing {
            animation: wordPulse 0.3s ease-in-out infinite alternate;
        }
        
        @keyframes wordPulse {
            from { transform: scale(1); box-shadow: 0 0 5px currentColor; }
            to { transform: scale(1.1); box-shadow: 0 0 15px currentColor; }
        }
        
        .highlighted-text .word.ok {
            /* æ­£ç¡®ï¼šé»˜è®¤é»‘è‰² */
            background: transparent;
            color: var(--text-primary);
        }
        
        .highlighted-text .word.weak {
            /* å¾…åŠ å¼ºï¼šæ©™è‰² */
            background: transparent;
            color: var(--color-weak);
            font-weight: 600;
        }
        
        .highlighted-text .word.poor {
            /* éœ€æ”¹è¿›ï¼šçº¢è‰² */
            background: transparent;
            color: var(--color-missing);
            font-weight: 600;
        }
        
        .highlighted-text .word.missing {
            /* ç¼ºå¤±ï¼šçº¢è‰²åˆ é™¤çº¿ */
            background: transparent;
            color: var(--color-missing);
            text-decoration: line-through;
            font-weight: 600;
            opacity: 0.7;
        }
        
        /* åº•éƒ¨åŒæ å¸ƒå±€ */
        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .analysis-section, .feedback-section {
            margin-bottom: 0; /* ç§»é™¤åº•éƒ¨é—´è· */
            padding: 20px;
            border-radius: 12px;
        }

        .analysis-section h2, .text-section h2, .feedback-section h2 {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                width: 100%;
                max-width: none;
                box-shadow: none;
            }
                box-shadow: none;
                border: 1px solid #eee;
                break-inside: avoid;
            }
            .print-btn { display: none; }
        }
        
        .print-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-body);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }
        .print-btn:hover {
            background: #2962FF;
        }
        
        .legend-item.ok { color: var(--text-primary); font-weight: 500; }
        .legend-item.weak { color: var(--color-weak); font-weight: 600; }
        .legend-item.poor { color: var(--color-missing); font-weight: 600; }
        .legend-item.missing { color: var(--color-missing); text-decoration: line-through; font-weight: 600; opacity: 0.7; }
        .legend-item.linking { color: var(--accent); font-weight: 600; border-bottom: 2px solid var(--accent); border-radius: 0 0 8px 8px; padding-bottom: 1px; }

        /* è¿è¯»å¼§çº¿æ ·å¼ */
        .link-arc {
            display: inline-block;
            vertical-align: bottom;
            margin: 0 -8px; /* è´Ÿè¾¹è·è®©å®ƒé‡å åœ¨å•è¯é—´éš™ */
            color: var(--accent);
            opacity: 0.8;
            pointer-events: none;
            width: 20px;
            height: 10px;
        }
        
        .word.weak[data-diagnosis]:after, .word.poor[data-diagnosis]:after {
            content: " ğŸ“";
            font-size: 0.7em;
            vertical-align: super;
            opacity: 0.8;
        }

        /* å¬å†™å¯¹æ¯”åŒºåŸŸ */
        .transcription-section {
            background: #F8FAFC;
            border-left: 4px solid #3B82F6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .transcription-section h3 {
            font-size: 0.95rem;
            color: #1E293B;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detected-content {
            font-family: var(--font-mono);
            font-size: 1rem;
            line-height: 1.6;
            color: #475569;
            background: #FFFFFF;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            white-space: pre-wrap;
        }
        
        .detected-content mark {
            background: #FEE2E2;
            color: #B91C1C;
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 600;
        }

        /* åˆ†æåŒºåŸŸ */
        .analysis-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .analysis-section h2 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .analysis-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
        }
        
        .analysis-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .analysis-card .items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .analysis-card .item {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .analysis-card .item:hover {
            transform: scale(1.1);
        }
        
        .analysis-card .item.weak {
            background: rgba(255, 193, 7, 0.2);
            color: var(--color-weak);
        }
        
        .analysis-card .item.missing {
            background: rgba(244, 67, 54, 0.2);
            color: var(--color-missing);
        }
        
        /* å‘éŸ³å¯¹æ¯”åŒºåŸŸ */
        .pronunciation-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .pronunciation-section h2 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        /* ELSA Style Pronunciation Cards */
        .phoneme-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .elsa-card {
            background: #FFFFFF;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .elsa-card-header {
            background: #F8FAFC;
            padding: 12px 16px;
            border-bottom: 1px solid #E2E8F0;
            font-weight: 700;
            color: #1E293B;
            font-size: 1rem;
        }

        .elsa-card-body {
            padding: 16px;
            flex-grow: 1;
        }

        .elsa-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748B;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .elsa-mistake-item {
            margin-bottom: 16px;
        }

        .elsa-mistake-text {
            font-size: 0.95rem;
            color: #334155;
            margin-bottom: 8px;
        }

        .elsa-word-list {
            list-style: disc;
            padding-left: 20px;
            color: #475569;
            font-size: 0.9rem;
        }

        .elsa-word-item {
            margin-bottom: 4px;
        }

        .elsa-word-highlight {
            color: #EF4444;
            font-weight: 600;
            text-decoration: line-through;
        }
        
        /* Modal Animation */
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .elsa-card-footer {
            padding: 16px;
            background: #F8FAFC;
            border-top: 1px solid #E2E8F0;
        }

        .elsa-improvement-tip {
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.5;
        }
        
        /* å»ºè®®åŒºåŸŸ */
        /* å»ºè®®åŒºåŸŸ */
        .feedback-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        .feedback-section h2 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        .feedback-summary {
            font-size: 1.1rem;
            margin-bottom: 16px;
            padding: 16px;
            background: rgba(41, 121, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            color: var(--text-primary);
        }
        
        .feedback-actions {
            margin-bottom: 16px;
        }
        
        .feedback-actions h3 {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .feedback-actions ol {
            padding-left: 20px;
            color: var(--text-secondary);
        }
        
        .feedback-actions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .practice-words {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }
        
        .practice-word {
            background: rgba(0, 0, 0, 0.05);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* é¡µè„š */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        /* æ— éŸ³é¢‘æç¤º */
        .no-audio-hint {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .no-audio-hint svg {
            width: 48px;
            height: 48px;
            opacity: 0.5;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1>ğŸ“„ {{ meta.student_id }} å£è¯­æŠ¥å‘Š</h1>
            <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ç”ŸæˆæŠ¥å‘Š</button>
        </div>
        
        <!-- è¯„åˆ†åŒºåŸŸ (ELSA Style) -->
        <div class="scores-section">
            <!-- ç»¼åˆè¯„åˆ†å¤§å¡ç‰‡ -->
            <div class="overall-card">
                <div class="ring-container" style="transform: scale(0.9); margin-bottom: -10px;">
                    <svg class="progress-ring" width="120" height="120">
                        <circle
                            class="progress-ring__circle-bg"
                            stroke="#e6e6e6"
                            stroke-width="10"
                            fill="transparent"
                            r="54"
                            cx="60"
                            cy="60"/>
                        <circle
                            class="progress-ring__circle"
                            stroke="url(#gradient)"
                            stroke-width="10"
                            fill="transparent"
                            r="54"
                            cx="60"
                            cy="60"
                            style="stroke-dasharray: 339; stroke-dashoffset: {{ 339 - (339 * scores.overall_100 / 100) }}"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#00E5FF" />
                                <stop offset="100%" stop-color="#2979FF" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="ring-center">
                        <div class="value" style="font-size: 2rem;">{{ scores.overall_100 | round(0) }}%</div>
                        <div class="unit">{{ get_level(scores.overall_100) }}</div>
                    </div>
                </div>
                <div class="overall-feedback">
                    <h2>Overall Speaking Score</h2>
                    <span class="level-badge">Current Level: {{ get_level(scores.overall_100) }}</span>
                    <p>ä½ çš„å£è¯­æ°´å¹³è¡¨ç°ä¸é”™ï¼ç»§ç»­ä¿æŒç»ƒä¹ ï¼Œé‡ç‚¹å…³æ³¨è¯­è°ƒçš„è‡ªç„¶è¿‡æ¸¡ï¼Œå°½é‡å‡å°‘ä¸è‡ªç„¶çš„åœé¡¿ã€‚</p>
                </div>
            </div>
            
            <!-- åˆ†é¡¹è¯„åˆ†å¡ç‰‡ç»„ -->
            <div class="breakdown-grid">
                <div class="skill-card pronunciation" onclick="openPronunciationModal()" style="cursor: pointer;">
                    <div class="skill-score">{{ scores.pronunciation_100 | round(0) }}%</div>
                    <div class="skill-label">Pronunciation ğŸ‘†</div>
                    <div class="skill-level">{{ get_level(scores.pronunciation_100) }}</div>
                </div>
                
                <div class="skill-card intonation" onclick="openIntonationModal()" style="cursor: pointer;">
                    <div class="skill-score">{{ scores.intonation_100 | round(0) }}%</div>
                    <div class="skill-label">Intonation ğŸ‘†</div>
                    <div class="skill-level">{{ get_level(scores.intonation_100) }}</div>
                </div>
                
                <div class="skill-card fluency" onclick="openFluencyModal()" style="cursor: pointer;">
                    <div class="skill-score">{{ scores.fluency_100 | round(0) }}%</div>
                    <div class="skill-label">Fluency ğŸ‘†</div>
                    <div class="skill-level">{{ get_level(scores.fluency_100) }}</div>
                </div>
                
                <div class="skill-card completeness" onclick="openCompletenessModal()" style="cursor: pointer;">
                    <div class="skill-score">{{ scores.completeness_100 | round(0) }}%</div>
                    <div class="skill-label">Completeness ğŸ‘†</div>
                    <div class="skill-level">{{ get_level(scores.completeness_100) }}</div>
                </div>
            </div>
        </div>
        

        
        <!-- å¬å†™å¯¹ç…§ (å¦‚æœæœ‰) -->
        {% if engine_raw.detected_transcript %}
        <div class="transcription-section">
            <h3>ğŸ‘‚ å¬å†™å¯¹ç…§ (Transcribe Refereed)</h3>
            <div class="detected-content">{{ engine_raw.detected_transcript }}</div>
            <p style="font-size: 0.8rem; color: #64748B; margin-top: 8px;">
                ğŸ’¡ <b>æç¤ºï¼š</b> è¿™æ˜¯ AI è€å¸ˆå®é™…å¬åˆ°çš„å†…å®¹ã€‚å¦‚æœä¸è„šæœ¬ä¸ç¬¦ï¼Œè¯·æ³¨æ„çº¢æ¡†æ ‡æ³¨çš„åå·®ã€‚
            </p>
        </div>
        {% endif %}

        <!-- æ–‡æœ¬é«˜äº® -->
        <div class="text-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin-bottom: 0;">ğŸ“ æœ—è¯»åˆ†æ</h2>
                {% if audio_base64 %}
                <audio controls style="height: 36px; border-radius: 18px;">
                    <source src="data:audio/mp3;base64,{{ audio_base64 }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                {% endif %}
            </div>
            <div class="highlighted-text" id="highlightedText">
                {% for word in alignment.words %}
                <span class="word {{ word.tag }}" 
                      title="{% if word.diagnosis %}è¯Šæ–­: {{ word.diagnosis }}{% else %}å¾—åˆ†: {{ word.score | round(1) }}{% endif %}"
                      data-start="{{ word.start }}"
                      data-end="{{ word.end }}"
                      data-index="{{ loop.index0 }}"
                      {% if word.diagnosis %}data-diagnosis="{{ word.diagnosis }}"{% endif %}>{{ word.word }}</span>
                {% endfor %}
            </div>
            <div class="legend">
                <span class="legend-item ok">æ­£ç¡®</span>
                <span class="legend-item weak">å¾…åŠ å¼º</span>
                <span class="legend-item poor">éœ€æ”¹è¿›</span>
                <span class="legend-item missing">ç¼ºå¤±</span>
            </div>
        </div>
        
        <!-- åˆ†æç»“æœä¸å»ºè®® - åŒæ  -->
        <div class="bottom-row">
            <!-- è¯¦ç»†åˆ†æ -->
            <div class="analysis-section">
                <h2>ğŸ” é‡ç‚¹å…³æ³¨</h2>
                <div class="analysis-grid" style="grid-template-columns: 1fr;">
                    {% if analysis.weak_words %}
                    <div class="analysis-card" style="padding: 10px;">
                        <h3 style="margin-bottom: 4px;">Words to improve</h3>
                        <div class="items">
                            {% for word in analysis.weak_words[:5] %}
                            <span class="item weak" data-word="{{ word }}">{{ word }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if analysis.missing_words %}
                    <div class="analysis-card" style="padding: 10px;">
                        <h3 style="margin-bottom: 4px;">Missing words</h3>
                        <div class="items">
                            {% for word in analysis.missing_words[:5] %}
                            <span class="item missing" data-word="{{ word }}">{{ word }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- æ”¹è¿›å»ºè®® -->
            <div class="feedback-section">
                <h2>ğŸ’¡ å­¦ä¹ å»ºè®®</h2>
                <div class="feedback-content" style="font-size: 0.9rem;">
                    <p style="margin-bottom: 8px;">{{ feedback.cn_summary }}</p>
                    <ul class="action-list">
                        {% for action in feedback.cn_actions[:2] %}
                        <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- å‘éŸ³æŒ‡å¯¼ -->
        {% if phoneme_tips %}
        <div class="pronunciation-section">
            <h2>ğŸ¯ å‘éŸ³æŒ‡å¯¼</h2>
            <div class="phoneme-cards">
                {% for tip in phoneme_tips %}
                <div class="phoneme-card">
                    <div class="phoneme-title">
                        <span class="phoneme-symbol">/{{ tip.phoneme }}/</span>
                        <span class="phoneme-name">{{ tip.name }}</span>
                    </div>
                    <div class="examples">
                        {% for example in tip.examples %}
                        <span class="example-word">{{ example }}</span>
                        {% endfor %}
                    </div>
                    <div class="tip">{{ tip.advice }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- AI è€å¸ˆç‚¹è¯„ -->


        <!-- è§„åˆ™åé¦ˆå»ºè®® -->
        {% if (feedback.cn_summary or feedback.cn_actions) and not advisor_feedback %}
        <div class="feedback-section">
            <h2>ğŸ’¡ æ”¹è¿›å»ºè®®</h2>
            {% if feedback.cn_summary %}
            <div class="feedback-summary">
                {{ feedback.cn_summary }}
            </div>
            {% endif %}
            
            {% if feedback.cn_actions %}
            <div class="feedback-actions">
                <h3>ç»ƒä¹ å»ºè®®</h3>
                <ol>
                    {% for action in feedback.cn_actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}
            
            {% if feedback.practice %}
            <div class="practice-words">
                {% for pair in feedback.practice %}
                <span class="practice-word">{{ pair }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        
    </div>

    <!-- å‘éŸ³åˆ†æè¯¦æƒ… Modal -->
    <div id="pronunciationModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ğŸ™ï¸ å‘éŸ³è¯¦æƒ… (Pronunciation)</h2>
                <button class="close-btn" onclick="closePronunciationModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- é¡¶éƒ¨å¾—åˆ†çŠ¶æ€ -->
                <div class="pro-header">
                    <div class="ring-container small">
                         <!-- å¤ç”¨ Doughnut Chart éœ€è¦ç‹¬ç«‹ Canvas ID -->
                         <div class="ring-center">
                            <div class="value" style="font-size: 1.8rem; color: #2979FF;">{{ scores.pronunciation_100 | round(0) }}%</div>
                            <div class="unit">{{ get_level(scores.pronunciation_100) }}</div>
                        </div>
                    </div>
                    <div class="pro-status">
                        <h3>å‘éŸ³è¡¨ç°: {{ get_level(scores.pronunciation_100) }}</h3>
                        <p>è¯·é‡ç‚¹å…³æ³¨ä¸‹æ–¹åˆ—å‡ºçš„éŸ³ç´ ã€‚è¿™æ˜¯æé«˜åˆ†æ•°çš„å…³é”®å“¦ï¼ ğŸ’ª</p>
                    </div>
                </div>

                <h3 style="margin: 20px 0 16px; color: #1E293B;">ğŸ” æ ¸å¿ƒå‘éŸ³è¯Šæ–­ (Top Errors Diagnostics)</h3>

                <!-- é”™è¯¯è¯¦æƒ…ç½‘æ ¼ (ELSA Style) -->
                <div class="phoneme-analysis-grid">
                    {% if advisor_feedback.top_errors %}
                        {% for error in advisor_feedback.top_errors %}
                        <div class="elsa-card">
                            <div class="elsa-card-header">
                                Sound {{ error.phoneme }}
                            </div>
                            <div class="elsa-card-body">
                                <div class="elsa-section-title">Words with Mistakes</div>
                                <div class="elsa-mistake-item">
                                    <div class="elsa-mistake-text">{{ error.description }}</div>
                                    <ul class="elsa-word-list">
                                        {% for w_name in error.words %}
                                        <li class="elsa-word-item" 
                                            onclick="jumpToWord('{{ w_name }}')"
                                            style="cursor: pointer;">
                                            {{ w_name }}
                                            {% for w in alignment.words if w.word.lower() == w_name.lower() and w.diagnosis %}
                                            <span style="display:block; font-size: 0.8rem; font-weight: normal; color: #DC2626; margin-top:2px;">
                                                è¯Šæ–­: {{ w.diagnosis }}
                                            </span>
                                            {% endfor %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="elsa-card-footer">
                                <div class="elsa-section-title">How to Improve</div>
                                <div class="elsa-improvement-tip">{{ error.improvement }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: #64748B;">
                            æœªæ£€æµ‹åˆ°æ˜¾è‘—çš„éŸ³ç´ é”™è¯¯ã€‚ç»§ç»­ä¿æŒï¼
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯­è°ƒåˆ†æè¯¦æƒ… Modal (ä¿ç•™) -->
    <div id="intonationModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>ğŸ—£ï¸ è¯­è°ƒåˆ†æ (Intonation)</h2>
                <button class="close-btn" onclick="closeIntonationModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p class="modal-desc">
                    <strong>å¯è§†åŒ–è¯´æ˜ï¼š</strong> 
                    <span style="color: #10B981; font-weight: bold;">ç»¿è‰²</span> = Native Speaker æ ‡å‡†è¯­è°ƒï¼Œ
                    <span style="font-weight: bold;">é»‘è‰²</span> = æ‚¨çš„è¯­è°ƒã€‚
                    <span style="color: var(--color-missing); font-weight: bold;">çº¢è‰²</span> = éœ€è¦æ”¹è¿›çš„è¯ã€‚
                    å¯¹æ¯”é«˜ä½å·®å¼‚ï¼Œæ¨¡ä»¿æ ‡å‡†çš„é‡éŸ³èŠ‚å¥ã€‚
                </p>
                
                <div class="intonation-visualizer">
                    <!-- åŒå±‚å®¹å™¨ -->
                    <div class="pitch-container" id="pitchContainer">
                        <!-- å‚è€ƒå±‚ (Native Speaker) -->
                        <div class="pitch-layer reference-layer" id="referenceLayer">
                            {% for word in alignment.words %}
                            {% set exp_size = 0.9 + (word.expected_stress|default(0.5) * 1.0) %}
                            <span class="viz-word ref-word" 
                                  style="font-size: {{ exp_size }}rem;"
                                  data-expected-stress="{{ word.expected_stress|default(0.5) }}">
                                {{ word.word }}
                            </span>
                            {% endfor %}
                        </div>
                        <!-- ç”¨æˆ·å±‚ -->
                        <div class="pitch-layer user-layer" id="userLayer">
                            {% for word in alignment.words %}
                            {% set size = 0.9 + (word.stress|default(0.5) * 1.0) %}
                            {% set color = '#1F2937' %}
                            {% if word.tag in ['weak', 'poor', 'missing'] %}
                                {% set color = '#FF1744' %}
                            {% endif %}
                            <span class="viz-word user-word" 
                                  style="font-size: {{ size }}rem; color: {{ color }};"
                                  data-stress="{{ word.stress|default(0.5) }}">
                                {{ word.word }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="modal-tips">
                    <h3>ğŸ’¡ å¦‚ä½•ä½¿ç”¨</h3>
                    <p><strong>ç»¿è‰²è¡Œ</strong>æ˜¯ Native Speaker çš„æ ‡å‡†é‡éŸ³èŠ‚å¥ï¼šå¤§å­—=é‡è¯»ï¼Œå°å­—=å¼±è¯»ã€‚<br>
                    <strong>é»‘è‰²è¡Œ</strong>æ˜¯æ‚¨çš„å®é™…å‘éŸ³ã€‚å¯¹æ¯”ä¸¤è¡Œï¼Œæ‰¾å‡ºå·®è·ï¼šå¦‚æœæ‚¨æŠŠè™šè¯è¯»å¾—å’Œå®è¯ä¸€æ ·é‡ï¼Œè¯­è°ƒä¼šæ˜¾å¾—ç”Ÿç¡¬ã€‚</p>
                </div>
            </div>
        </div>
    </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <p>ç”±å£è¯­è¯„åˆ†ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ | Submission ID: {{ meta.submission_id }}</p>
        </div>
    </div>
    
    <style>
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100000;
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            margin: 0;
            color: var(--accent);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .modal-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
            padding: 12px;
            background: #F8FAFC;
            border-radius: 8px;
        }

        .intonation-visualizer {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow-x: auto; /* Allow scrolling for long sentences */
            padding: 40px 20px;
            border: 1px solid #eee;
        }

        .pitch-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .pitch-layer {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 12px 16px;
            padding: 15px 20px;
            border-radius: 12px;
            min-height: 60px;
        }

        .reference-layer {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border: 1px solid #A7F3D0;
        }

        .user-layer {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
        }

        .viz-word {
            font-family: var(--font-heading);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .ref-word {
            color: #059669;
            font-weight: 500;
        }

        .user-word {
            font-weight: 500;
        }

        .viz-word:hover {
            transform: scale(1.1);
        }

        .modal-tips {
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .modal-tips h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .modal-tips p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
    </style>

        /* å‘éŸ³è¯¦æƒ…æ ·å¼ - Parent Friendly Optimized */
        .pro-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding-bottom: 24px;
            border-bottom: 1px solid #eee;
            margin-bottom: 24px;
        }
        
        .phoneme-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        
        .pattern-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: transform 0.2s;
        }
        .pattern-card:hover { transition: transform 0.2s; transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.06); }
        
        .pattern-header {
            background: #F8FAFC;
            padding: 14px 20px;
            border-bottom: 1px solid #EEF2F6;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .phoneme-badge {
            font-family: var(--font-heading);
            font-weight: 700;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            color: var(--text-primary);
        }
        
        .phoneme-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .pattern-section {
            padding: 20px;
        }
        
        .mistake-item {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #F1F5F9;
        }
        .mistake-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        
        /* å¯¹æ¯”è§†å›¾æ ¸å¿ƒæ ·å¼ */
        .comparison-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .comp-box {
            flex: 1;
            background: #F8FAFC;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid transparent;
        }
        
        .comp-box.error {
            background: #FEF2F2;
            border-color: #FEE2E2;
        }
        
        .comp-box.target {
            background: #F0FDF4;
            border-color: #DCFCE7;
        }
        
        .comp-box .label {
            font-size: 0.75rem;
            color: #64748B;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .comp-box.error .label { color: #EF4444; }
        .comp-box.target .label { color: #10B981; }
        
        .comp-box .value {
            font-family: var(--font-heading);
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .comp-arrow {
            color: #CBD5E1;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .mistake-desc {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--text-secondary);
            text-align: center;
            background: #F8FAFC;
            padding: 6px;
            border-radius: 6px;
        }
        
        .example-area {
            background: #FFFFF;
            border: 1px dashed #E2E8F0;
            border-radius: 8px;
            padding: 12px;
        }
        
        .example-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .example-words {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .example-words li {
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .ex-text {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .ex-ipa {
            color: #94A3B8;
            font-family: inherit;
        }
        
        .ex-ipa .err {
            color: var(--color-missing);
            font-weight: 700;
            background: #FEF2F2; /* è½»å¾®çº¢è‰²èƒŒæ™¯ */
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .pattern-section.footer {
            margin-top: auto;
            border-top: 1px solid #EEF2F6;
            background: #F8FAFC;
            padding: 16px 20px;
        }
        
        .pattern-section.footer p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #475569;
        }

        /* Gemini 3 Insight Card */
        .gemini-insight-card {
            background: linear-gradient(135deg, #F0F9FF 0%, #E6F3FF 100%);
            border: 1px solid #BAE6FD;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(2, 132, 199, 0.05);
        }
        
        .gemini-insight-card::before {
            content: "";
            position: absolute;
            top: -20px;
            right: -20px;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .gemini-header {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #0284C7;
            font-weight: 800;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gemini-header span {
            font-size: 1.2rem;
        }

        .gemini-motto {
            font-family: var(--font-heading);
            font-size: 1.3rem; /* å¤§å·åº§å³é“­ */
            font-weight: 700;
            color: #0C4A6E;
            margin-bottom: 12px;
            font-style: italic;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }

        .gemini-advice {
            color: #334155;
            font-size: 0.95rem;
            line-height: 1.7;
            position: relative;
            z-index: 1;
        }
    </style>

    <script>
        // Modal Control
        window.openIntonationModal = function() {
            document.getElementById('intonationModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            if (!pitchInitialized) {
                initPitchCurve();
                pitchInitialized = true;
            }
        }

        window.closeIntonationModal = function() {
            document.getElementById('intonationModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Pitch Curve Drawing Logic
        function initPitchCurve() {
            const pitchData = {{ pitch_contour | tojson | default('[]') }};
            const words = {{ alignment.words | tojson | default('[]') }};
            
            if (words.length === 0) return;

            const container = document.getElementById('pitchContainer');
            const svg = document.getElementById('pitchSvg');
            const wordsContainer = document.getElementById('pitchWords');
            
            // 1. è®¡ç®— F0 èŒƒå›´
            const f0s = pitchData.map(p => p.f).filter(f => f > 0);
            let minF0 = f0s.length > 0 ? Math.min(...f0s) : 100;
            let maxF0 = f0s.length > 0 ? Math.max(...f0s) : 300;
            
            // æ”¾å¤§èŒƒå›´ç¡®ä¿æœ‰è¶³å¤Ÿçš„å‚ç›´å˜åŒ–
            if (maxF0 - minF0 < 30) {
                minF0 -= 40;
                maxF0 += 40;
            } else {
                minF0 -= 20;
                maxF0 += 20;
            }
            const f0Range = maxF0 - minF0;

            // 2. ç´§å‡‘å¸ƒå±€ï¼šè®¡ç®—æ¯ä¸ªå•è¯çš„Xä½ç½®ï¼ˆå›ºå®šé—´è·ï¼‰
            const wordEls = wordsContainer.querySelectorAll('.viz-word');
            const containerHeight = 180;
            const wordGap = 20; // å›ºå®šé—´è·
            let currentX = 20; // èµ·å§‹ä½ç½®
            
            const wordPositions = [];
            wordEls.forEach((el, i) => {
                const w = words[i];
                const x = currentX;
                currentX += el.offsetWidth + wordGap;
                
                // æŸ¥æ‰¾è¯¥å•è¯æ—¶é—´æ®µå†…çš„å¹³å‡ F0
                const wordPitches = pitchData.filter(p => p.t >= w.start && p.t <= w.end);
                let avgF0 = (minF0 + maxF0) / 2; // é»˜è®¤ä¸­é—´
                if (wordPitches.length > 0) {
                    avgF0 = wordPitches.reduce((sum, p) => sum + p.f, 0) / wordPitches.length;
                } else if (w.stress !== undefined) {
                    // å¦‚æœæ²¡æœ‰ pitch æ•°æ®ï¼Œç”¨ stress ä¼°ç®—
                    avgF0 = minF0 + (w.stress || 0.5) * f0Range;
                }
                
                // Y ä½ç½®ï¼šé«˜éŸ³é«˜ -> ä¸Šæ–¹
                const yRatio = (avgF0 - minF0) / f0Range;
                const y = containerHeight - (yRatio * 100 + 30); // 30-130px èŒƒå›´
                
                wordPositions.push({ x, y, width: el.offsetWidth });
                
                el.style.left = x + 'px';
                el.style.top = y + 'px';
            });
            
            // 3. è®¾ç½®å®¹å™¨å®½åº¦
            const totalWidth = currentX + 20;
            container.style.width = totalWidth + 'px';
            svg.setAttribute('width', totalWidth);
            svg.setAttribute('height', containerHeight);
            
            // 4. ç»˜åˆ¶è¿æ¥å„å•è¯ä¸­å¿ƒçš„å¹³æ»‘æ›²çº¿
            if (wordPositions.length > 1) {
                const points = wordPositions.map((p, i) => ({
                    x: p.x + p.width / 2,
                    y: p.y + 15  // å•è¯ä¸­å¿ƒåä¸‹
                }));
                
                // ä½¿ç”¨è´å¡å°”æ›²çº¿å¹³æ»‘è¿æ¥
                let pathD = `M ${points[0].x} ${points[0].y}`;
                for (let i = 1; i < points.length; i++) {
                    const prev = points[i - 1];
                    const curr = points[i];
                    const cpx = (prev.x + curr.x) / 2;
                    pathD += ` Q ${cpx} ${prev.y}, ${curr.x} ${curr.y}`;
                }
                
                svg.innerHTML = `<path d="${pathD}" fill="none" stroke="#CBD5E1" stroke-width="2" stroke-dasharray="4,4" opacity="0.6"/>`;
            } else {
                svg.innerHTML = '';
            }
        }

        // Initialize when modal opened
        let pitchInitialized = false;
        
        window.openPronunciationModal = function() {
            document.getElementById('pronunciationModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        window.closePronunciationModal = function() {
            document.getElementById('pronunciationModal').classList.remove('active');
            document.body.style.overflow = '';
        }

    </script>
    <!-- æµåˆ©åº¦åˆ†æè¯¦æƒ… Modal (Fluency/Pausing/Hesitations) -->
    <div id="fluencyModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ã€°ï¸ æµåˆ©åº¦åˆ†æ (Fluency Analysis)</h2>
                <button class="close-btn" onclick="closeFluencyModal()">Ã—</button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="modal-tabs">
                <button class="tab-btn active" data-tab="pausing" onclick="switchFluencyTab('pausing', this)">Pausing (åœé¡¿)</button>
                <button class="tab-btn" data-tab="pace" onclick="switchFluencyTab('pace', this)">Pace (è¯­é€Ÿ)</button>
                <button class="tab-btn" data-tab="hesitations" data-tab="hesitations" onclick="switchFluencyTab('hesitations', this)">Hesitations (è¿Ÿç–‘)</button>
            </div>

            <div class="modal-body">
                 
                 <!-- Tab 1: Pausing -->
                 <div id="tab-pausing" class="tab-content active">
                    <!-- é¡¶éƒ¨å¾—åˆ†çŠ¶æ€ -->
                    <div class="pro-header">
                        <div class="ring-container small">
                             <div class="ring-center">
                                <div class="value" style="font-size: 1.8rem; color: #FFA000;">{{ scores.fluency_100 | round(0) }}%</div>
                                <div class="unit">{{ get_level(scores.fluency_100) }}</div>
                            </div>
                        </div>
                    <!-- Gemini 3 Discovery -->
                    {% if advisor_feedback and advisor_feedback.fluency_diagnosis %}
                    <div class="gemini-insight-card">
                        <div class="gemini-header">
                            <span>âœ¨</span> Gemini 3 Fluency Insight
                        </div>
                        <div class="gemini-motto">
                            "{{ advisor_feedback.fluency_diagnosis.motto }}"
                        </div>
                        <div class="gemini-advice">
                            {{ advisor_feedback.fluency_diagnosis.advice }}
                        </div>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: #0284C7;">
                            <strong>Diagnosis:</strong> {{ advisor_feedback.fluency_diagnosis.status }}
                        </div>
                    </div>
                    {% endif %}
                    </div> <!-- Close pro-header -->

                    <!-- å›¾ä¾‹ Legend -->
                    <div class="legend-bar">
                        <div class="legend-item"><span class="mark-icon good">H</span> Good Pauses (åˆç†åœé¡¿)</div>
                        <div class="legend-item"><span class="mark-icon optional">H</span> Optional Pauses (å¯é€‰åœé¡¿)</div>
                        <div class="legend-item"><span class="mark-icon bad">H</span> Bad Pauses (ä¸å½“å¡é¡¿)</div>
                        <div class="legend-item"><span class="mark-icon missed">I</span> Missed Pauses (æ¼åœ)</div>
                    </div>

                    <!-- Transcript Area -->
                    <div class="transcript-box">
                        <h3>Transcript</h3>
                        <div class="transcript-content">
                            {% for word in alignment.words %}
                                <span class="t-word">{{ word.word }}</span>
                                
                                {% if word.pause %}
                                    {% if word.pause.type == 'missed' %}
                                        <span class="pause-mark missed" title="Missed Pause"></span>
                                    {% else %}
                                        <!-- Dynamic width based on duration (mock logic: 0.1s = 5px) -->
                                        <span class="pause-mark h-bar {{ word.pause.type }}" 
                                              style="width: 40px;" 
                                              title="{{ word.pause.type|capitalize }}: {{ word.pause.duration }}">
                                        </span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                 </div>

                 <div id="tab-pace" class="tab-content">
                    {% set avg_wpm = 0 %}
                    {# Unified data path to avoid nested scoping issues #}
                    {% set current_pace_data = pace_chart_data | default(analysis.pace_chart_data) | default([]) %}
                    
                    {% if current_pace_data and current_pace_data|length > 0 %}
                         {% set avg_wpm = (current_pace_data | map(attribute='y') | sum / current_pace_data|length) | int %}
                    {% endif %}
                    
                    {% set pace_status = "Natural" %}
                    {% set pace_msg = "Your pace is natural and easy to follow. Great job!" %}
                    {% set pace_color = "#22c55e" %} {# Green #}
                    
                    {# Logic for Status and Gauge Needle #}
                    {# Map 0-250 WPM to -90 to 90 deg #}
                    {% set needle_deg = ((avg_wpm / 250) * 180 - 90) %}
                    {% if needle_deg > 90 %} {% set needle_deg = 90 %} {% endif %}
                    {% if needle_deg < -90 %} {% set needle_deg = -90 %} {% endif %}

                    {% if avg_wpm < 120 %}
                        {% set pace_status = "Too Slow" %}
                        {% set pace_msg = "Your pace was a little Too slow during this recording!" %}
                        {% set pace_color = "#f59e0b" %} {# Amber #}
                    {% elif avg_wpm > 180 %}
                        {% set pace_status = "Too Fast" %}
                        {% set pace_msg = "Whoa! You're speaking a bit too fast. Try to slow down for better clarity." %}
                        {% set pace_color = "#ef4444" %} {# Red #}
                    {% endif %}

                    <div class="pace-inner-box" style="padding: 24px; min-height: 400px; display: block !important;">
                        <h2 style="font-size: 1.6rem; color: #1E293B; margin-bottom: 24px; border-bottom: 2px solid #F1F5F9; padding-bottom: 12px;">ğŸ“Š Pace Analysis Overview</h2>
                        <div class="pace-overview" style="display: flex; gap: 40px; align-items: flex-start; margin-bottom: 40px;">
                        <div class="gauge-section" style="flex: 0 0 250px; position: relative;">
                             <svg width="250" height="150" viewBox="0 0 250 150" class="gauge-svg">
                                <!-- Background Track -->
                                <path d="M 30 130 A 90 90 0 0 1 220 130" fill="none" stroke="#F1F5F9" stroke-width="24" stroke-linecap="round" />
                                
                                <!-- Color Zones -->
                                <!-- Slow Zone (50-120) -->
                                <path d="M 30 130 A 90 90 0 0 1 100 50" fill="none" stroke="#F59E0B" stroke-width="24" stroke-opacity="0.2" />
                                <!-- Natural Zone (120-180) -->
                                <path d="M 100 50 A 90 90 0 0 1 150 50" fill="none" stroke="#22C55E" stroke-width="24" stroke-opacity="0.8" />
                                <!-- Fast Zone (180-250) -->
                                <path d="M 150 50 A 90 90 0 0 1 220 130" fill="none" stroke="#EF4444" stroke-width="24" stroke-opacity="0.2" />

                                <!-- Needle (More Premium Design) -->
                                <g class="gauge-needle" style="transform: rotate({{ needle_deg }}deg); transform-origin: 125px 130px; transition: transform 2s cubic-bezier(0.34, 1.56, 0.64, 1);">
                                    <path d="M 122 130 L 125 45 L 128 130 Z" fill="#334155" />
                                    <circle cx="125" cy="130" r="10" fill="#334155" />
                                    <circle cx="125" cy="130" r="4" fill="#94A3B8" />
                                </g>

                                <!-- Labels -->
                                <text x="25" y="145" font-size="12" fill="#94A3B8" font-weight="600">Slow</text>
                                <text x="125" y="145" font-size="12" fill="#22C55E" text-anchor="middle" font-weight="700">Natural</text>
                                <text x="225" y="145" font-size="12" fill="#EF4444" text-anchor="end" font-weight="600">Fast</text>
                                
                                <!-- Scale Ticks (Deeper Gray) -->
                                <text x="42" y="112" font-size="9" fill="#94A3B8" font-weight="600">50</text>
                                <text x="72" y="72" font-size="9" fill="#94A3B8" font-weight="600">90</text>
                                <text x="125" y="42" font-size="9" fill="#94A3B8" text-anchor="middle" font-weight="600">150</text>
                                <text x="178" y="72" font-size="9" fill="#94A3B8" font-weight="600">210</text>
                                <text x="210" y="112" font-size="9" fill="#94A3B8" font-weight="600">250</text>
                            </svg>
                            <div style="text-align: center; margin-top: -25px; position: relative; z-index: 10;">
                                <div style="font-size: 2.8rem; font-weight: 900; color: #0F172A; line-height: 1; letter-spacing: -1px;">{{ avg_wpm }}</div>
                                <div style="font-size: 0.8rem; color: #64748B; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;">wpm</div>
                                <div style="margin-top: 10px; display: inline-block; padding: 4px 12px; background: {{ pace_color }}15; color: {{ pace_color }}; border-radius: 20px; font-size: 0.9rem; font-weight: 800; border: 1px solid {{ pace_color }}30;">
                                    {{ pace_status }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="pace-text" style="flex: 1; padding-top: 5px;">
                            <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px;">
                                <h3 style="font-size: 1.8rem; font-weight: 800; color: #1E293B; margin: 0;">Pace</h3>
                                <div style="font-size: 0.9rem; color: #94A3B8; cursor: help;" title="Words Per Minute: A measure of talking speed.">â“˜</div>
                            </div>
                            <p style="font-size: 1.15rem; color: #475569; margin-bottom: 24px; line-height: 1.6;">{{ pace_msg }}</p>
                            
                            <div style="background: #F0F9FF; border-radius: 16px; padding: 20px; border: 1px dashed #BAE6FD; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.05; transform: rotate(15deg);">ğŸ’¡</div>
                                <div style="font-weight: 800; color: #0369A1; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px;">
                                    <span>âœ¨</span> Top Performance Tip
                                </div>
                                <div style="font-size: 1rem; color: #0C4A6E; line-height: 1.6; font-weight: 500;">
                                    To sound more natural, aim for clusters of **5-8 words** between pauses. This creates a rhythmic flow that engages your audience.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pace-trend-card" style="background: white; border-radius: 16px; border: 1px solid #E2E8F0; padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1E293B; margin-bottom: 8px;">An overview of your Pace during this recording</h3>
                            <p style="font-size: 0.95rem; color: #64748B;">Make sure you maintain a natural pace (between <strong>120 and 180 words per minute</strong>) when you speak. This will help your audience to stay connected with you!</p>
                        </div>
                        
                        <div class="chart-container" style="height: 300px; width: 100%; position: relative;">
                            <canvas id="paceChart"></canvas>
                            <!-- Axis Labels Overlay -->
                            <div style="position: absolute; left: 0; top: 0; font-size: 0.8rem; color: #94A3B8;">Wpm 250</div>
                            <div style="position: absolute; right: 0; bottom: -20px; font-size: 0.8rem; color: #94A3B8;">Timestamp</div>
                            
                            <div style="position: absolute; right: 12px; top: 120px; font-size: 0.75rem; color: #10B981; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8;">Normal</div>
                            <div style="position: absolute; right: 12px; top: 20px; font-size: 0.75rem; color: #EF4444; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8;">Too Fast</div>
                            <div style="position: absolute; right: 12px; bottom: 50px; font-size: 0.75rem; color: #F59E0B; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8;">Too Slow</div>
                        </div>
                    </div>
                    </div> <!-- Close pace-inner-box -->
                 </div>


                 <!-- Tab 3: Hesitations -->
                 {% if hesitations %}
                 <div id="tab-hesitations" class="tab-content">
                    <div class="hesi-dashboard">
                        <div class="hesi-ring">
                            <div class="ring-circle">
                                <span>â‰ˆ</span>
                                <div class="label">{{ hesitations.score_label }}</div>
                            </div>
                        </div>
                        <div class="hesi-info">
                            <h3>Hesitations (è¿Ÿç–‘)</h3>
                            <p>{{ hesitations.desc }}</p>
                        </div>
                    </div>
                    
                    <div class="hesi-cols">
                        <div class="hesi-col">
                            <h4>Frequent filler words</h4>
                            <div class="filler-chart">
                                {% for item in hesitations.fillers %}
                                <div class="filler-row">
                                    <span class="f-word">{{ item.word }}</span>
                                    <div class="f-bar-container">
                                        <div class="f-bar" style="width: {{ item.count * 20 }}px;"></div>
                                    </div>
                                    <span class="f-count">{{ item.count }} times</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="hesi-col">
                            <h4>Say these sentences confidently</h4>
                            {% for ex in hesitations.examples %}
                            <div class="hesi-example">
                                <div class="ex-row you">
                                    <span class="label">You:</span>
                                    <!-- Highlight filler if simple string match -->
                                    <span class="text">{{ ex.original_text.replace(ex.filler, '<span class="filler">' + ex.filler + '</span>') | safe }}</span>
                                </div>
                                <div class="ex-row try">
                                    <span class="label">Try:</span>
                                    <span class="text">{{ ex.clean_text }}</span>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="hesi-tips">
                                <h4>Suggestion</h4>
                                <ul>
                                    {% for tip in hesitations.tips %}
                                    <li>âœ… {{ tip }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                 </div>
                 {% endif %}

            </div>
        </div>
    </div>

    <style>
        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            padding: 0 24px;
        }
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 1rem;
            color: #64748B;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .tab-btn.active {
            color: #2563EB;
            border-bottom-color: #2563EB;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        /* Active tab must be visible - using high specificity */
        .modal-body .tab-content.active {
            display: block !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Fluency Specific Styles */
        .legend-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 12px;
            background: #FAFAFA;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #555;
        }
        
        .mark-icon {
            display: inline-block;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .mark-icon.good { color: #4CAF50; }
        .mark-icon.bad { color: #FF5252; }
        .mark-icon.optional { color: #9E9E9E; }
        .mark-icon.missed { color: #FF5252; border-left: 3px solid #FF5252; height: 12px; width: 0; content: ' '; }
        
        .transcript-box {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 24px;
        }
        
        .transcript-content {
            font-size: 1.1rem;
            line-height: 2.2; /* High line-height for pause bars */
            color: #333;
        }
        
        .t-word {
            display: inline-block;
        }
        
        /* Pause Visualization */
        .pause-mark {
            display: inline-block;
            vertical-align: middle;
            margin: 0 6px;
            position: relative;
        }
        
        /* Missed Pause (I-Bar) */
        .pause-mark.missed {
            height: 24px;
            width: 4px;
            background-color: #FF5252;
            border-radius: 2px;
            transform: translateY(-2px);
        }
        
        /* H-Bar Style */
        .pause-mark.h-bar {
            height: 14px;
            border-left: 2px solid;
            border-right: 2px solid;
            min-width: 20px;
        }
        
        .pause-mark.h-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: currentColor;
            transform: translateY(-50%);
        }
        
        .pause-mark.good { color: #4CAF50; border-color: #4CAF50; }
        .pause-mark.bad { color: #FF5252; border-color: #FF5252; }
        .pause-mark.optional { color: #BDBDBD; border-color: #BDBDBD; }
        
        /* Pace Chart Styles */
        .pace-box {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 24px;
        }
        .pace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .pace-legend {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dot-legend.natural {
            width: 12px;
            height: 12px;
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5); 
            display: inline-block;
        }
        .pace-desc {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }
        
        /* Hesitations Styles */
        .hesi-dashboard {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 30px;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 12px;
        }
        .hesi-ring .ring-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 6px solid #4CAF50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #4CAF50;
        }
        .hesi-ring span { font-size: 2rem; line-height: 1; }
        .hesi-ring .label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase;}
        
        .hesi-cols { display: flex; gap: 40px; }
        .hesi-col { flex: 1; }
        .hesi-col h4 { margin-top: 0; margin-bottom: 16px; font-size: 1rem; color: #334155;}
        
        .filler-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        .f-word { width: 60px; font-weight: 500; }
        .f-bar-container { flex: 1; margin: 0 12px; }
        .f-bar { height: 8px; background: #FCD34D; border-radius: 4px; }
        .f-count { width: 60px; text-align: right; color: #94A3B8; font-size: 0.8rem;}
        
        .hesi-example {
            background: #fff;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .ex-row { display: flex; gap: 12px; margin-bottom: 8px; font-size: 0.95rem; }
        .ex-row:last-child { margin-bottom: 0; }
        .ex-row .label { font-weight: 600; width: 80px; flex-shrink: 0; }
        .ex-row.you .label { color: #64748B; }
        .ex-row.try .label { color: #10B981; }
        .ex-row .text .filler { color: #F59E0B; font-weight: bold; }
        
        .hesi-tips ul { padding-left: 20px; margin: 0; }
        .hesi-tips li { margin-bottom: 8px; color: #475569; font-size: 0.9rem; }

    </style>

    <script>
        // Fluency Modal Tab Logic
        function switchFluencyTab(tabName, btnElement) {
            console.log("Switching to tab:", tabName);
            
            // 1. Update Tab Buttons
            document.querySelectorAll('.modal-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            if (btnElement) {
                btnElement.classList.add('active');
            } else {
                // Try to find it by text or data-tab if needed, but usually btnElement is passed
                console.warn("btnElement not passed to switchFluencyTab");
            }
            
            // 2. Hide all tab content - relying on CSS class is safer
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                // Don't force style.display if we use !important in CSS, but let's be safe
                content.style.setProperty('display', 'none', 'important'); 
            });
            
            // 3. Show target tab content
            const targetContent = document.getElementById(`tab-${tabName}`);
            if (targetContent) {
                targetContent.classList.add('active');
                targetContent.style.setProperty('display', 'block', 'important');
                console.log("Tab content shown:", `tab-${tabName}`);
            } else {
                console.error("Tab content NOT found in DOM:", `tab-${tabName}`);
            }
            
            // 4. Handle Pace Chart Specifics
            if (tabName === 'pace') {
                if (typeof initPaceChart === 'function') {
                    initPaceChart();
                } else {
                    console.error("initPaceChart is not defined!");
                }
            }
        }
        
        // Fluency Modal
        let paceChartInstance = null;
        
        function openFluencyModal() {
            document.getElementById('fluencyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Re-init chart if we are on the pace tab
            const activeBtn = document.querySelector('.modal-tabs .tab-btn.active');
            if (activeBtn && activeBtn.getAttribute('data-tab') === 'pace') {
                initPaceChart();
            }
        }

        function closeFluencyModal() {
            document.getElementById('fluencyModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function initPaceChart() {
            console.log("Initializing Pace Chart...");
            const chartCanvas = document.getElementById('paceChart');
            if (!chartCanvas) {
                console.error("paceChart canvas not found in DOM");
                return;
            }
            const ctx = chartCanvas.getContext('2d');
            
            // Safer data extraction - Use global context directly
            let rawData = [];
            try {
                // Try top-level first, then nested
                rawData = {{ pace_chart_data | default(analysis.pace_chart_data) | default([]) | tojson }};
                console.log("Pace Data loaded successfully:", rawData);
            } catch (e) {
                console.error("Failed to parse pace data from Jinja:", e);
            }
            
            if (!rawData || rawData.length === 0) {
                console.warn("Pace Data is empty - rendering placeholder");
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.font = "14px Inter";
                ctx.fillStyle = "#94A3B8";
                ctx.textAlign = "center";
                ctx.fillText("Not enough speech data for pace analysis", chartCanvas.width / 2, chartCanvas.height / 2);
                return;
            } 
            
            // Custom Plugin to draw the "Natural Zone" background
            const naturalZonePlugin = {
                id: 'naturalZone',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                    const yHigh = y.getPixelForValue(180);
                    const yLow = y.getPixelForValue(120);
                    
                    ctx.save();
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.1)'; 
                    ctx.fillRect(left, yHigh, right - left, yLow - yHigh);
                    ctx.restore();
                }
            };

            if (window.paceChartInstance) {
                window.paceChartInstance.destroy();
                window.paceChartInstance = null;
            }
            
            window.paceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'WPM',
                        data: rawData,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.45,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 60,
                            bottom: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 250,
                            grid: { 
                                color: '#F1F5F9',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94A3B8',
                                font: { size: 10, weight: 600 },
                                stepSize: 50
                            }
                        },
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            grid: { display: false },
                            ticks: {
                                color: '#94A3B8',
                                font: { size: 10, weight: 600 },
                                callback: (val) => val + 's'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#0F172A',
                            titleFont: { size: 13, weight: 700 },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => ` âš¡ï¸ Speed: ${ctx.parsed.y} WPM`
                            }
                        }
                    }
                },
                plugins: [naturalZonePlugin]
            });
        }
    </script>
    <!-- å®Œæ•´åº¦åˆ†æè¯¦æƒ… Modal (Completeness) -->
    <div id="completenessModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ğŸ§© å®Œæ•´åº¦åˆ†æ (Completeness Analysis)</h2>
                <button class="close-btn" onclick="closeCompletenessModal()">Ã—</button>
            </div>
            <div class="modal-body">
                {% if completeness_analysis %}
                <!-- Metrics Dashboard -->
                <div class="comp-dashboard">
                    <div class="comp-metric main">
                        <div class="c-value">{{ completeness_analysis.coverage }}%</div>
                        <div class="c-label">å†…å®¹è¦†ç›–ç‡ (Coverage)</div>
                    </div>
                    <div class="comp-divider"></div>
                    <div class="comp-metric">
                        <div class="c-value red">{{ completeness_analysis.missing_stats.total }}</div>
                        <div class="c-label">æ¼è¯»è¯æ•° (Missed)</div>
                    </div>
                    <div class="comp-metric">
                        <div class="c-value">{{ completeness_analysis.missing_stats.keywords }}</div>
                        <div class="c-label">æ¼è¯»å®è¯ (Keywords)</div>
                    </div>
                    <div class="comp-metric">
                        <div class="c-value">{{ completeness_analysis.missing_stats.function_words }}</div>
                        <div class="c-label">æ¼è¯»è™šè¯ (Function)</div>
                    </div>
                </div>

                <!-- Insight Alert -->
                <div class="comp-insight">
                    <span class="icon">ğŸ’¡</span>
                    <span class="text">{{ completeness_analysis.insight }}</span>
                </div>

                <!-- Ghost Text View -->
                <div class="ghost-box">
                    <h3>Ghost Words View (å¹½çµæ–‡å­—)</h3>
                    <p class="ghost-desc">
                        ä¸‹æ–‡ä¸­ <span class="ghost-word demo">faded words</span> æ˜¯ä½ æ¼è¯»çš„éƒ¨åˆ†ã€‚
                    </p>
                    <div class="ghost-content">
                        {% for word in alignment.words %}
                            {% if word.tag == 'missing' %}
                                <span class="ghost-word" title="You missed this word">{{ word.word }}</span>
                            {% else %}
                                <span class="normal-word">{{ word.word }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Tips -->
                <div class="comp-tips">
                    <h4>æ”¹è¿›å»ºè®® (Suggestions)</h4>
                    <ul>
                        {% for tip in completeness_analysis.tips %}
                        <li>ğŸ¯ {{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <style>
        /* Completeness Styles */
        .comp-dashboard {
            display: flex;
            align-items: center;
            background: #F8FAFC;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            justify-content: space-around;
        }
        .comp-metric { text-align: center; }
        .comp-metric .c-value { font-size: 1.8rem; font-weight: 700; color: #1E293B; line-height: 1.2; }
        .comp-metric .c-value.red { color: #EF4444; }
        .comp-metric.main .c-value { font-size: 2.5rem; color: #3B82F6; }
        .comp-metric .c-label { font-size: 0.8rem; color: #64748B; text-transform: uppercase; margin-top: 4px; font-weight: 600; }
        .comp-divider { width: 1px; height: 50px; background: #E2E8F0; }

        .comp-insight {
            background: #EFF6FF;
            border: 1px solid #DBEAFE;
            padding: 16px;
            border-radius: 8px;
            color: #1E40AF;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .ghost-box {
            background: white;
            border: 2px dashed #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .ghost-box h3 { margin-top: 0; color: #334155; }
        .ghost-desc { color: #64748B; font-size: 0.9rem; margin-bottom: 16px; }
        
        .ghost-content {
            font-size: 1.2rem;
            line-height: 1.8;
            color: #1E293B;
        }
        .normal-word { margin-right: 4px; }
        .ghost-word {
            display: inline-block;
            color: #EF4444;
            opacity: 0.4;
            text-decoration: line-through;
            margin-right: 4px;
            font-weight: bold;
        }
        .ghost-word.demo { margin: 0 4px; }

        .comp-tips h4 { color: #334155; margin-bottom: 12px; }
        .comp-tips ul { padding-left: 20px; color: #475569; }
        .comp-tips li { margin-bottom: 8px; }
    </style>

    <script>
        function openCompletenessModal() {
            document.getElementById('completenessModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeCompletenessModal() {
            document.getElementById('completenessModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        // Fallback: Add event listeners manually to ensure clicks work
        document.addEventListener('DOMContentLoaded', function() {
            const fluencyCard = document.querySelector('.skill-card.fluency');
            if (fluencyCard) {
                fluencyCard.addEventListener('click', function(e) {
                    console.log("Fluency card clicked via listener");
                    e.preventDefault();
                    if (window.openFluencyModal) {
                        window.openFluencyModal();
                    } else {
                        console.error("openFluencyModal not found on window");
                    }
                });
            }

            const intonationCard = document.querySelector('.skill-card.intonation');
            if (intonationCard) {
                intonationCard.addEventListener('click', function(e) {
                    console.log("Intonation card clicked via listener");
                    e.preventDefault();
                    if (window.openIntonationModal) {
                        window.openIntonationModal();
                    }
                });
            }
            
            const pronunciationCard = document.querySelector('.skill-card.pronunciation');
            if (pronunciationCard) {
                pronunciationCard.addEventListener('click', function(e) {
                     e.preventDefault();
                     if (window.openPronunciationModal) window.openPronunciationModal();
                });
            }
            
             const completenessCard = document.querySelector('.skill-card.completeness');
            if (completenessCard) {
                completenessCard.addEventListener('click', function(e) {
                     e.preventDefault();
                     if (window.openCompletenessModal) window.openCompletenessModal();
                });
            }

            // All tab clicks are handled by switchFluencyTab(tabName, this) via onclick attribute.
        });
    </script>
</body>
</html>
